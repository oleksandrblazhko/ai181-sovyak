# Загальна iнформацiя

Веб-файли cookie (тут іменуються як файли cookie) часто є основним вектором атаки для зловмисників (зазвичай націлених на інших користувачів), і програма завжди повинна докладати належної уваги, щоб захистити файли cookie.

HTTP є протоколом без стану, тобто він не містить жодних посилань на запити, які надсилає той самий користувач. Щоб вирішити цю проблему, сеанси були створені та додані до HTTP-запитів. Браузери, як обговорювалося в тестуванні сховища браузера, містять безліч механізмів зберігання. У цьому розділі посібника докладно обговорюється кожен.

### Найбільш використовуваним механізмом зберігання сеансів у браузерах є зберігання файлів cookie. Файли cookie можуть бути встановлені сервером, включивши заголовок Set-Cookie у відповідь HTTP або за допомогою JavaScript. Файли cookie можна використовувати з багатьох причин, наприклад:

- управління сеансами
- персоналізація
- відстеження
Щоб захистити дані файлів cookie, галузь розробила засоби, які допомагають заблокувати ці файли cookie та обмежити їхню поверхню атаки. З часом файли cookie стали кращим механізмом зберігання в Інтернеті
додатків, оскільки вони забезпечують велику гнучкість у використанні та захисті.

## Засоби захисту файлів cookie:

- Атрибути файлів cookie
- Префікси файлів cookie
- Цілі тесту
Переконайтеся, що для файлів cookie встановлено правильну конфігурацію безпеки.

### Як тестувати
Нижче буде розглянуто опис кожного атрибута та префікса. Тестер повинен перевірити, чи правильно вони використовуються програмою. Файли cookie можна переглянути за допомогою проксі-сервера-перехоплювача або переглянувши файл cookie у браузері.

### Атрибути файлів cookie
Захищений атрибут
Атрибут Secure повідомляє веб-переглядачу надсилати файли cookie, лише якщо запит надсилається через безпечний канал, наприклад HTTPS. Це допоможе захистити файли cookie від передачі в незашифрованих запитах. Якщо до програми можна отримати доступ як через HTTP, так і через HTTPS, зловмисник зможе перенаправити користувача для надсилання файлів cookie як частину незахищених запитів.

Атрибут HttpOnly
Атрибут HttpOnly використовується для запобігання таким атакам, як витік сеансу, оскільки він не дозволяє отримати доступ до файлу cookie через клієнтський сценарій, наприклад JavaScript.

Це не обмежує всю поверхню атаки XSS-атак, оскільки зловмисник може надіслати запит замість користувача, але значно обмежує охоплення векторів атаки XSS.

Атрибут домену
Атрибут Domain використовується для порівняння домену cookie з доменом сервера, для якого виконується запит HTTP. Якщо домен збігається або якщо це субдомен, далі буде перевірено атрибут шляху.

Зауважте, що лише хости, які належать до вказаного домену, можуть установлювати файли cookie для цього домену. Крім того, атрибут домену не може бути доменом верхнього рівня (наприклад, .gov або .com), щоб сервери не могли встановлювати довільні файли cookie для іншого домену (наприклад, встановлення файлу cookie для owasp.org). Якщо атрибут домену не встановлено, тоді ім’я хоста сервера, який створив файл cookie, використовується як значення домену за замовчуванням.

Наприклад, якщо файл cookie встановлено програмою на app.mydomain.com без установленого атрибута домену, тоді файл cookie буде повторно надіслано для всіх наступних запитів для app.mydomain.com та його субдоменів (таких як hacker.app.mydomain .com), але не на otherapp.mydomain.com. Якби розробник хотів послабити це обмеження, він міг би встановити атрибут домену на mydomain.com. У цьому випадку файл cookie надсилатиметься на всі запити для субдоменів app.mydomain.com і mydomain.com, наприклад hacker.app.mydomain.com і навіть bank.mydomain.com. Якщо в піддоміні був уразливий сервер (наприклад, otherapp.mydomain.com), а атрибут домену було встановлено занадто вільно (наприклад, mydomain.com), то вразливий сервер міг використовуватися для збору файлів cookie (наприклад, токени сесії) у всьому діапазоні mydomain.com.

Атрибут шляху
Атрибут Path відіграє важливу роль у встановленні обсягу файлів cookie в поєднанні з доменом. Окрім домену, можна вказати URL-шлях, для якого дійсний файл cookie. Якщо домен і шлях збігаються, файл cookie буде надіслано в запиті. Подібно до атрибута домену, якщо атрибут шляху встановлено занадто вільно, це може зробити програму вразливою для атак з боку інших програм на тому самому сервері. Наприклад, якщо для атрибута шляху було встановлено корінь веб-сервера /, то файли cookie програми надсилатимуться кожній програмі в межах одного домену (якщо кілька програм розташовано на одному сервері). Кілька прикладів для кількох програм на одному сервері:

- path=/bank
- path=/private
- path=/docs
- path=/docs/admin

Термін дії атрибута
Атрибут Expires використовується для:

встановити постійні файли cookie
обмежити тривалість життя, якщо сесія триває надто довго
видалити файл cookie примусово, встановивши для нього минулу дату
На відміну від сеансових файлів cookie, постійні файли cookie використовуватимуться браузером, доки не закінчиться термін їх дії. Коли термін дії перевищить встановлений час, браузер видалить файл cookie.

Атрибут SameSite
Атрибут SameSite використовується для підтвердження того, що файли cookie не слід надсилати разом із міжсайтовими запитами. Ця функція дозволяє серверу зменшити ризик витоку міжсистемної інформації. У деяких випадках він також використовується як стратегія зменшення ризику (або механізм глибокого захисту) для запобігання атакам підробки міжсайтових запитів. Цей атрибут можна налаштувати в трьох різних режимах:

- Strict
- Lax
- None

Суворе значення
Значення Strict — це найбільш обмежене використання SameSite, яке дозволяє браузеру надсилати файли cookie лише в основний контекст без навігації верхнього рівня. Іншими словами, дані, пов’язані з файлами cookie, надсилатимуться лише за запитами, що відповідають поточному сайту, який відображається в рядку URL-адреси браузера. Файли cookie не надсилатимуться за запитами, створеними сторонніми веб-сайтами. Це значення особливо рекомендовано для дій, які виконуються в одному домені. Однак це може мати деякі обмеження, оскільки деякі системи керування сеансами негативно впливають на навігацію користувача. Оскільки веб-переглядач не буде надсилати файли cookie на будь-які запити, згенеровані стороннім доменом або електронною поштою, користувачеві потрібно буде повторно ввійти, навіть якщо він уже має автентифікований сеанс.

Незначне значення
Значення Lax є менш обмежувальним, ніж Strict. Файл cookie буде надіслано, якщо URL-адреса збігається з доменом файлу cookie (першої сторони), навіть якщо посилання надходить із домену третьої сторони. Більшість браузерів вважають це значення поведінкою за замовчуванням, оскільки воно забезпечує кращу взаємодію з користувачем, ніж значення Strict. Він не активується для активів, таких як зображення, для доступу до яких можуть не знадобитися файли cookie.

Немає значення
Значення None вказує, що браузер надсилатиме файл cookie на міжсайтові запити (звичайна поведінка до реалізації SamseSite), лише якщо також використовується атрибут Secure, наприклад. SameSite=Жодного; Безпечний. Це рекомендоване значення замість того, щоб не вказувати значення SameSite, оскільки воно примусово використовує атрибут secure.

Префікси файлів cookie
За задумом файли cookie не мають можливостей гарантувати цілісність і конфіденційність інформації, що зберігається в них. Ці обмеження не дозволяють серверу бути впевненим у тому, як атрибути певного файлу cookie були встановлені під час створення. Щоб надати серверам такі функції за допомогою зворотної сумісності, індустрія запровадила концепцію префіксів імен файлів cookie, щоб полегшити передачу таких деталей, вбудованих як частину імені файлу cookie.

Префікс хоста
Префікс Host- передбачає, що файли cookie відповідатимуть таким умовам:
Файл cookie має бути встановлено з атрибутом Secure.
Файл cookie має бути встановлено з URI, який агент користувача вважає безпечним.
Надсилається лише хосту, який встановив файл cookie, і НЕ ПОВИНЕН містити атрибути домену.
Для файлу cookie має бути встановлено атрибут Pathat зі значенням /, щоб він надсилався на кожен запит до хосту.

З цієї причини файл cookie Set-Cookie: Host-SID=12345; Secure; Path=/ буде прийнято, тоді як будь-який із наступних завжди буде відхилено:
Set-Cookie: Host-SID=12345 Set-Cookie: Host-SID=12345; Secure Set-Cookie: Host-SID=12345; Domain=site.example Set-Cookie: Host-SID=12345; Domain=site.example; Path=/ Set-Cookie: Host-SID=12345; Secure; Domain=site.example; Path=/
Захищений префікс
Префікс Secure- є менш обмежувальним і може бути введений шляхом додавання чутливого до регістру рядка Secure- до імені файлу cookie. Будь-який файл cookie, який відповідає префіксу Secure-, повинен відповідати таким умовам:

Файл cookie має бути встановлено з атрибутом Secure.
Файл cookie має бути встановлено з URI, який агент користувача вважає безпечним.
Сильні практики
Виходячи з потреб програми та того, як має функціонувати файл cookie, потрібно застосовувати атрибути та префікси. Чим більше файл cookie заблоковано, тим краще.

Зібравши все це разом, ми можемо визначити найбільш безпечну конфігурацію атрибута cookie як:

Set-Cookie: Host-SID=<session token>; path=/; Secure; HttpOnly; SameSite=Strict
